<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZUNRDP | ULTIMATE SYSTEM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #07090e; color: #f1f5f9; font-family: sans-serif; }
        .card { background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.05); border-radius: 24px; }
        .progress-bar { transition: width 0.5s ease-in-out; }
    </style>
</head>
<body class="p-4 md:p-10">

    <div id="login-box" class="max-w-md mx-auto mt-20 card p-8 border-t-4 border-blue-500 shadow-2xl">
        <h1 class="text-3xl font-black text-center text-blue-500 mb-8 italic">ZUNRDP SYSTEM</h1>
        <input type="text" id="u" placeholder="Username" class="w-full p-4 mb-4 bg-black/40 rounded-xl border border-white/10 outline-none">
        <input type="password" id="p" placeholder="Password" class="w-full p-4 mb-8 bg-black/40 rounded-xl border border-white/10 outline-none">
        <button onclick="login()" class="w-full py-4 bg-blue-600 rounded-xl font-bold hover:bg-blue-500 transition active:scale-95">ĐĂNG NHẬP</button>
        <p class="text-center text-xs text-gray-500 mt-4 cursor-pointer" onclick="register()">Chưa có tài khoản? Đăng ký</p>
    </div>

    <div id="main" class="hidden max-w-6xl mx-auto">
        <div class="flex flex-col md:flex-row justify-between items-center mb-10 gap-4">
            <h2 id="hello" class="text-2xl font-black italic text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500"></h2>
            <div class="flex gap-2">
                <button id="admin-btn" onclick="showAdmin()" class="hidden bg-yellow-600/20 text-yellow-500 px-4 py-2 rounded-xl font-bold text-xs border border-yellow-500/20">ADMIN PANEL</button>
                <button onclick="location.reload()" class="bg-red-600/20 text-red-500 px-4 py-2 rounded-xl font-bold text-xs border border-red-500/20">LOGOUT</button>
            </div>
        </div>

        <div id="member-area">
            <div class="card p-6 mb-10">
                <p class="text-[10px] font-bold text-gray-500 uppercase mb-3">Kích hoạt bằng mã Key</p>
                <div class="flex flex-col md:flex-row gap-4">
                    <input type="text" id="k" placeholder="ZUN-XXXX" class="flex-1 p-4 bg-black/40 rounded-2xl border border-white/10 text-center font-bold text-blue-400">
                    <button onclick="create()" id="btn-create" class="px-10 py-4 bg-blue-600 rounded-2xl font-black text-xs uppercase italic">Khởi tạo</button>
                </div>
            </div>
            <div id="vm-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>

        <div id="admin-area" class="hidden space-y-10">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
                <div class="card p-8">
                    <h3 class="text-blue-400 font-bold text-xs uppercase mb-6">Cấp/Sửa Thành Viên</h3>
                    <div class="space-y-4">
                        <input type="text" id="adm-u" placeholder="Target Username" class="w-full p-4 bg-black/40 rounded-xl border border-white/5">
                        <input type="text" id="adm-tk" placeholder="GitHub Token" class="w-full p-4 bg-black/40 rounded-xl border border-white/5">
                        <input type="text" id="adm-rp" placeholder="User/Repo" class="w-full p-4 bg-black/40 rounded-xl border border-white/5">
                        <input type="text" id="adm-ts" placeholder="Tailscale Key riêng" class="w-full p-4 bg-black/40 rounded-xl border border-yellow-500/10">
                        <input type="number" id="adm-l" placeholder="Giới hạn VM" class="w-full p-4 bg-black/40 rounded-xl border border-white/5">
                        <button onclick="grant()" class="w-full py-4 bg-blue-600 rounded-xl font-bold uppercase text-xs">Xác nhận cấp</button>
                    </div>
                </div>
                <div class="card p-8">
                    <h3 class="text-blue-400 font-bold text-xs uppercase mb-6">Thành Viên Hệ Thống</h3>
                    <div id="user-list" class="space-y-4"></div>
                </div>
            </div>
            <div class="card p-8">
                <h3 class="text-red-500 font-bold text-xs uppercase mb-6">Toàn bộ máy đang chạy (Live Monitoring)</h3>
                <div id="all-vms" class="grid grid-cols-1 md:grid-cols-3 gap-6"></div>
            </div>
        </div>
    </div>

    <script>
        const API = "https://zunrdp-default-rtdb.asia-southeast1.firebasedatabase.app";
        let me = "", role = "";

        async function login() {
            const u = document.getElementById('u').value.trim().toLowerCase();
            const p = document.getElementById('p').value;
            if(u === 'zunrdp' && p === '26082007ngoc') {
                me = u; role = 'admin';
                document.getElementById('admin-btn').classList.remove('hidden');
                showMain(); return;
            }
            const res = await fetch(`${API}/users/${u}.json`).then(r => r.json());
            if(res && res.password === p) {
                if(res.status === 'banned') return alert("Bạn đã bị BAN!");
                me = u; role = 'member';
                showMain();
            } else alert("Sai tài khoản!");
        }

        async function register() {
            const u = document.getElementById('u').value.trim().toLowerCase();
            const p = document.getElementById('p').value;
            if(!u || !p) return alert("Nhập đủ TK/MK");
            await fetch(`${API}/users/${u}.json`, { method:'PUT', body: JSON.stringify({password:p, status:'active', key:'WAITING', limit:1}) });
            alert("Đăng ký thành công!");
        }

        function showMain() {
            document.getElementById('login-box').style.display = 'none';
            document.getElementById('main').classList.remove('hidden');
            document.getElementById('hello').innerText = (role === 'admin' ? "ADMIN MASTER" : `MEMBER: ${me.toUpperCase()}`);
            startSync();
        }

        function showAdmin() {
            document.getElementById('member-area').classList.add('hidden');
            document.getElementById('admin-area').classList.remove('hidden');
        }

        async function create() {
            const k = document.getElementById('k').value.trim();
            const userData = await fetch(`${API}/users/${me}.json`).then(r => r.json());
            const vms = await fetch(`${API}/vms.json`).then(r => r.json()) || {};
            
            if(k !== userData.key) return alert("Sai Key!");
            const myVMs = Object.values(vms).filter(v => v.owner === me).length;
            if(myVMs >= userData.limit) return alert("Vượt giới hạn máy ảo!");

            document.getElementById('btn-create').innerText = "...";
            await fetch(`https://api.github.com/repos/${userData.repo}/actions/workflows/vm.yml/dispatches`, {
                method:'POST',
                headers: { 'Authorization': `Bearer ${userData.token}` },
                body: JSON.stringify({ ref: 'main', inputs: { owner_name: me, ts_key: userData.ts_key } })
            });
            alert("Đã gửi lệnh tạo máy!");
            document.getElementById('btn-create').innerText = "Khởi tạo";
        }

        function startSync() {
            setInterval(async () => {
                const [vms, users] = await Promise.all([
                    fetch(`${API}/vms.json`).then(r => r.json()),
                    fetch(`${API}/users.json`).then(r => r.json())
                ]);
                renderVMs(vms, 'vm-list', me); // Render cho Member
                if(role === 'admin') {
                    renderVMs(vms, 'all-vms', null); // Render toàn bộ cho Admin
                    renderUsers(users);
                }
            }, 5000);
        }

        function renderVMs(vms, targetId, filterOwner) {
            let h = '';
            for(let id in vms) {
                const v = vms[id];
                if(filterOwner && v.owner !== filterOwner) continue;
                
                const uptime = Math.floor((Date.now() - v.startTime) / 60000);
                h += `
                <div class="card p-6 border-l-4 border-blue-500">
                    <div class="flex justify-between mb-4">
                        <span class="text-xs font-bold text-blue-400">${v.id}</span>
                        <span class="text-[9px] text-gray-500 uppercase">${v.owner}</span>
                    </div>
                    <div class="space-y-3 mb-4">
                        <div class="text-[10px] flex justify-between text-gray-400"><span>CPU: ${v.cpu}%</span><span>RAM: ${v.ram}%</span></div>
                        <div class="h-1 bg-white/5 rounded-full overflow-hidden"><div class="progress-bar h-full bg-blue-500" style="width:${v.cpu}%"></div></div>
                        <div class="h-1 bg-white/5 rounded-full overflow-hidden"><div class="progress-bar h-full bg-purple-500" style="width:${v.ram}%"></div></div>
                    </div>
                    <div class="bg-black/40 p-3 rounded-xl text-[10px] font-mono border border-white/5 mb-4">
                        <p class="text-blue-300">IP: ${v.ip}</p>
                        <p>User: ${v.user} | Pass: <span class="text-yellow-500">${v.pass}</span></p>
                        <p class="text-gray-500 mt-1">Uptime: ${uptime} phút</p>
                    </div>
                    <button onclick="kill('${id}')" class="w-full py-2 bg-red-600/10 text-red-500 rounded-lg text-[9px] font-bold border border-red-500/10">KILL VM</button>
                </div>`;
            }
            document.getElementById(targetId).innerHTML = h || '<p class="text-xs text-gray-600 italic py-10">No VMs running</p>';
        }

        async function grant() {
            const u = document.getElementById('adm-u').value.trim().toLowerCase();
            const t = document.getElementById('adm-tk').value.trim();
            const r = document.getElementById('adm-rp').value.trim();
            const ts = document.getElementById('adm-ts').value.trim();
            const l = document.getElementById('adm-l').value || 1;
            const key = "ZUN-" + Math.floor(Math.random()*9000 + 1000);
            await fetch(`${API}/users/${u}.json`, { method:'PATCH', body: JSON.stringify({token:t, repo:r, ts_key:ts, limit:parseInt(l), key:key, status:'active'}) });
            alert("Đã cấp quyền!");
        }

        async function ban(u, isBan) {
            const status = isBan ? 'active' : 'banned';
            await fetch(`${API}/users/${u}.json`, { method:'PATCH', body: JSON.stringify({status: status}) });
            if(!isBan) {
                const vms = await fetch(`${API}/vms.json`).then(r => r.json()) || {};
                for(let id in vms) if(vms[id].owner === u) await fetch(`${API}/commands/${id}.json`, { method:'PUT', body: JSON.stringify({action:'stop'}) });
                alert(`Đã BAN ${u} và kill toàn bộ máy!`);
            }
        }

        function renderUsers(users) {
            let h = '';
            for(let n in users) {
                const b = users[n].status === 'banned';
                h += `<div class="p-4 bg-black/30 rounded-2xl flex justify-between items-center">
                    <div><p class="text-xs font-bold ${b?'text-red-500 line-through':''}">${n}</p><p class="text-[9px] text-gray-500">Key: ${users[n].key}</p></div>
                    <button onclick="ban('${n}', ${b})" class="px-4 py-2 rounded-xl text-[9px] font-bold ${b?'bg-green-600':'bg-red-600'}">${b?'UNBAN':'BAN'}</button>
                </div>`;
            }
            document.getElementById('user-list').innerHTML = h;
        }

        async function kill(id) {
            await fetch(`${API}/commands/${id}.json`, { method:'PUT', body: JSON.stringify({action:'stop'}) });
        }
    </script>
</body>
</html>

