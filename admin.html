<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>ZUNRDP | Admin Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-[#05070a] text-gray-200 p-6 md:p-10">
    <div class="max-w-6xl mx-auto">
        <div class="flex justify-between items-center mb-10">
            <h1 class="text-2xl font-black text-yellow-500 italic">ADMIN PANEL</h1>
            <button onclick="window.location.href='login.html'" class="text-xs bg-red-500/20 text-red-500 px-4 py-2 rounded-lg">Đăng xuất</button>
        </div>

        <div class="bg-gray-900/50 p-6 rounded-3xl border border-yellow-500/20 mb-10">
            <h3 class="text-yellow-500 text-xs font-bold uppercase mb-4">Cấu hình Tailscale Cloud (Dùng cho toàn hệ thống)</h3>
            <div class="flex gap-4">
                <input type="text" id="ts-key" placeholder="tskey-auth-..." class="flex-1 bg-black p-4 rounded-xl border border-white/5 outline-none focus:border-yellow-500">
                <button onclick="saveTS()" class="bg-yellow-600 px-8 rounded-xl font-bold text-black uppercase text-xs">Lưu Key</button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-10">
            <div class="bg-gray-900/50 p-8 rounded-3xl border border-white/5">
                <h3 class="text-blue-400 text-xs font-bold uppercase mb-6">Cấp quyền Member</h3>
                <div class="space-y-4">
                    <input type="text" id="target-user" placeholder="Username cần cấp" class="w-full bg-black p-4 rounded-xl border border-white/5">
                    <input type="text" id="gh-token" placeholder="GitHub Token" class="w-full bg-black p-4 rounded-xl border border-white/5">
                    <input type="text" id="gh-repo" placeholder="User/Repo" class="w-full bg-black p-4 rounded-xl border border-white/5">
                    <input type="number" id="v-limit" placeholder="Giới hạn VM" class="w-full bg-black p-4 rounded-xl border border-white/5">
                    <button onclick="grant()" class="w-full py-4 bg-blue-600 rounded-xl font-bold text-xs uppercase italic">Xác nhận cấp Key</button>
                </div>
            </div>

            <div class="lg:col-span-2 bg-gray-900/50 p-8 rounded-3xl border border-white/5">
                <h3 class="text-blue-400 text-xs font-bold uppercase mb-6">Quản lý Thành viên</h3>
                <div id="user-list" class="space-y-4"></div>
            </div>
        </div>
    </div>

    <script>
        const API = "https://zunrdp-default-rtdb.asia-southeast1.firebasedatabase.app";

        async function saveTS() {
            const key = document.getElementById('ts-key').value.trim();
            await fetch(`${API}/config.json`, { method:'PATCH', body: JSON.stringify({ts_key: key}) });
            alert("Đã cập nhật Tailscale Key!");
        }

        async function grant() {
            const u = document.getElementById('target-user').value.toLowerCase().trim();
            const t = document.getElementById('gh-token').value.trim();
            const r = document.getElementById('gh-repo').value.trim();
            const l = document.getElementById('v-limit').value || 1;
            const key = "ZUN-" + Math.floor(1000 + Math.random() * 9000);
            
            await fetch(`${API}/users/${u}.json`, {
                method: 'PATCH',
                body: JSON.stringify({ token: t, repo: r, limit: parseInt(l), key: key, status: 'active' })
            });
            alert(`Đã cấp Key: ${key} cho ${u}`);
            loadUsers();
        }

        async function ban(u, isBan) {
            const status = isBan ? 'active' : 'banned';
            await fetch(`${API}/users/${u}.json`, { method:'PATCH', body: JSON.stringify({status: status}) });
            if(!isBan) { // Nếu ban, kill hết máy
                const vms = await fetch(`${API}/vms.json`).then(r => r.json()) || {};
                for(let id in vms) if(vms[id].owner === u) await fetch(`${API}/commands/${id}.json`, { method:'PUT', body: JSON.stringify({action:'stop'}) });
            }
            loadUsers();
        }

        async function loadUsers() {
            const users = await fetch(`${API}/users.json`).then(r => r.json()) || {};
            let h = '';
            for(let n in users) {
                const b = users[n].status === 'banned';
                h += `<div class="p-4 bg-black/50 rounded-2xl flex justify-between items-center border border-white/5">
                    <div><p class="font-bold ${b?'text-red-500 line-through':''}">${n.toUpperCase()}</p><p class="text-[10px] text-gray-500">Key: ${users[n].key} | Limit: ${users[n].limit}</p></div>
                    <button onclick="ban('${n}', ${b})" class="px-4 py-2 rounded-lg text-[10px] font-bold uppercase ${b?'bg-green-600':'bg-red-600'}">${b?'Unban':'Ban'}</button>
                </div>`;
            }
            document.getElementById('user-list').innerHTML = h;
            const cfg = await fetch(`${API}/config.json`).then(r => r.json());
            if(cfg && cfg.ts_key) document.getElementById('ts-key').value = cfg.ts_key;
        }
        loadUsers();
    </script>
</body>
</html>

